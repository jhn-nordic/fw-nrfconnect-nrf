#
# Copyright (c) 2021 Nordic Semiconductor ASA
#
# SPDX-License-Identifier: LicenseRef-Nordic-5-Clause
#

if MEMFAULT

config MEMFAULT_NCS_USE_DEFAULT_METRICS
	bool
	select MEMFAULT_METRICS_EXTRA_DEFS_FILE
	default y if (MEMFAULT_NCS_STACK_METRICS || MEMFAULT_NCS_LTE_METRICS)

config MEMFAULT_NCS_PROJECT_KEY
	string "Memfault API key"
	help
	  Memfault project key

config MEMFAULT_NCS_DEVICE_ID
	string "Memfault device ID"
	help
	  Unique device ID

config MEMFAULT_NCS_DEVICE_SERIAL_USE_IMEI
	bool "Use IMEI as Memfault device serial"
	depends on AT_CMD
	default y if BOARD_NRF9160DK_NRF9160NS || BOARD_THINGY91_NRF9160NS
	help
	  Use the device's IMEI as device ID

config MEMFAULT_NCS_HW_VERSION
	string "Hardware version"
	default "nrf9160dk" if BOARD_NRF9160DK_NRF9160NS
	default "thingy91" if BOARD_THINGY91_NRF9160NS
	help
	  Device hardware version

config MEMFAULT_NCS_FW_TYPE
	string "Firmware type"
	default "nrf91ns-fw" if BOARD_NRF9160DK_NRF9160NS || BOARD_THINGY91_NRF9160NS
	help
	  Firmware type running on the board

choice MEMFAULT_FW_VERSION
	prompt "Firmware version generation method"
	default MEMFAULT_NCS_FW_VERSION_AUTO
	help
	  Method to use to generate firmware version


config MEMFAULT_NCS_FW_VERSION_STATIC
	bool "Static firmware version"
	help
	  Use statically configured firmware version, as opposed to a
	  dynamically generated one

config MEMFAULT_NCS_FW_VERSION_AUTO
	bool "Dynamic firmware version"
	help
	  Use dyanimically generated firmware version. The version is
	  re-generated on every compiler run
endchoice

config MEMFAULT_NCS_FW_VERSION_PREFIX
	string "Firmware version prefix"
	depends on MEMFAULT_NCS_FW_VERSION_AUTO
	default "0.0.1+"
	help
	  Prefix to use in front of automatically generated build version string.
	  If the build version string is "a1b2c3d", the full firmware version
	  will become "<prefix>a1b2c3d".

config MEMFAULT_NCS_INIT_PRIORITY
	int "memfault initialization priority"
	range AT_CMD_INIT_PRIORITY 99 if MEMFAULT_NCS_DEVICE_SERIAL_USE_IMEI
	default 90
	help
	  If IMEI is used as device ID, the initialization priority must be
	  greater than that of the AT command module

config MEMFAULT_NCS_PROVISION_CERTIFICATES
	bool "Provision certificates on initalization"
	depends on  MEMFAULT_ROOT_CERT_STORAGE_NRF9160_MODEM
	default y
	help
	  Provision required TLS root certificates for connecting to Memfault's
	  endpoints. If this option is disabled, the user is responsible for
	  calling the appropriate Memfault APIs for provisioning the
	  certificates before attempting to connect to Memfault servers.

config MEMFAULT_NCS_STACK_METRICS
	bool "Collect stack metrics"
	select THREAD_ANALYZER
	select THREAD_NAME
	default y
	help
	  Collect metrics for unused stack space for selected stacks.
	  Currently the following stacks' unused space is monitored:
		- at_cmd_socket_thread, used by the AT command library
		- connection_poll_thread, used by the cloud libraries for
		  nRF Cloud, AWS IoT and Azure IoT Hub

config MEMFAULT_NCS_STACK_CHECK_INTERVAL
	int "Stack check interval in seconds"
	depends on MEMFAULT_NCS_STACK_METRICS
	default 3600
	help
	  Stack checks are performed periodically and on every heartbeat.
	  This configuration option can be used to change how often the stack
	  check is performed.

config MEMFAULT_NCS_LTE_METRICS
	bool "Collect LTE metrics"
	select LTE_LC_TRACE
	depends on LTE_LINK_CONTROL
	help
	  Capture LTE metrics while the application is running. Supported
	  metrics are time to connect and number of connection establishments.

config MEMFAULT_NCS_INTERNAL_FLASH_BACKED_COREDUMP
	bool "Save coredump to internal flash instead of RAM"
	select MEMFAULT_COREDUMP_STORAGE_CUSTOM
	depends on FLASH
	depends on IMG_MANAGER
	depends on BOOTLOADER_MCUBOOT
	depends on MCUBOOT_IMG_MANAGER
	help
	  Use internal flash to store coredump data

if MEMFAULT_NCS_INTERNAL_FLASH_BACKED_COREDUMP
config MEMFAULT_NCS_FLASH_REGION_SIZE
	hex
	default $(dt_node_int_prop_hex,$(DT_CHOSEN_ZEPHYR_FLASH),erase-block-size)

partition=MEMFAULT_STORAGE
partition-size=0x10000
source "${ZEPHYR_BASE}/../nrf/subsys/partition_manager/Kconfig.template.partition_size"
endif # MEMFAULT_NCS_INTERNAL_FLASH_BACKED_COREDUMP

module = MEMFAULT_NCS
module-dep = LOG
module-str = Memfault NCS module
source "${ZEPHYR_BASE}/subsys/logging/Kconfig.template.log_config"


endif # MEMFAULT
